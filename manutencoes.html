<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>üß∞ Manuten√ß√µes - Del√≠cia & Mercatto</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<style>
:root{
  --bg:#0b0f19;--card:#151d2f;--accent:#ff8f1f;--accent2:#ffb347;
  --text:#f8fafc;--muted:#94a3b8;--green:#22c55e;--red:#ef4444;
  --shadow:0 4px 10px rgba(0,0,0,.4);
}
body{margin:0;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);}
header{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#000;text-align:center;padding:14px;font-weight:700;font-size:18px;
  box-shadow:0 3px 8px rgba(0,0,0,.4);
}
.container{max-width:950px;margin:auto;padding:16px;}
.section{background:var(--card);border-radius:16px;padding:18px;box-shadow:var(--shadow);margin-bottom:18px;}
.stats{display:flex;justify-content:space-around;text-align:center;margin-bottom:10px;}
.stat-box{background:#1e293b;padding:12px 18px;border-radius:10px;box-shadow:inset 0 0 10px rgba(0,0,0,.2);}
.stat-box h2{margin:0;color:var(--accent);font-size:22px;}
.stat-box p{margin:4px 0 0;font-size:13px;color:var(--muted);}
button{border:0;border-radius:8px;font-weight:600;cursor:pointer;padding:8px 12px;font-size:14px;}
.btn-primary{background:var(--accent);color:#000;}
.btn-gray{background:#334155;color:#fff;}
.toast{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  background:var(--accent);color:#000;padding:10px 18px;border-radius:999px;
  font-weight:600;box-shadow:var(--shadow);display:none;z-index:9999;
}
.popup-bg{
  position:fixed;inset:0;background:rgba(0,0,0,.7);
  display:flex;align-items:center;justify-content:center;
  z-index:10000;backdrop-filter:blur(2px);
}
.popup{
  background:#1e293b;border-radius:12px;padding:20px;
  max-width:420px;width:90%;box-shadow:0 4px 18px rgba(0,0,0,.6);
}
.popup textarea{
  width:100%;min-height:70px;margin-top:10px;border-radius:8px;
  border:1px solid #334155;background:#0f172a;color:#fff;padding:8px;
  resize:none;font-size:13px;
}
footer{text-align:center;color:var(--muted);font-size:12px;padding:16px;}
.fc{background:var(--card);border-radius:12px;padding:10px;}
.fc-toolbar-title{color:var(--accent);}
.fc-daygrid-day-number{color:var(--text);}
.fc-event{border:0;border-radius:6px;font-size:12px;padding:2px 4px;}
.fc-event-pendente{background:var(--red);}
.fc-event-concluido{background:var(--green);}
.fc-event-outro{background:var(--accent2);color:#000;}
</style>
</head>
<body>
<header>üß∞ Manuten√ß√µes Programadas</header>

<div class="container">
  <div class="section" style="text-align:center">
    <h3 id="empresaTitulo"></h3>
    <p id="usuarioInfo" style="color:var(--muted);font-size:14px"></p>
  </div>

  <div class="stats">
    <div class="stat-box">
      <h2 id="pendentesMes">0</h2><p>Pendentes no M√™s</p>
    </div>
    <div class="stat-box">
      <h2 id="concluidasMes">0</h2><p>Conclu√≠das no M√™s</p>
    </div>
  </div>

  <div class="section">
    <div id="calendar"></div>
  </div>

  <div style="text-align:center;margin-top:20px">
    <button class="btn-primary" onclick="finalizarDia()">‚úÖ Finalizar Dia</button>
    <button class="btn-gray" onclick="voltar()">‚¨Ö Voltar</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const GAS_URL='https://script.google.com/macros/s/AKfycbymySoncD4zG-shT3qrsC9P-a62dXt5-9gXppQ5TsuEJvd0jHCTSXpBTu2k1YmljUry/exec';
const $=s=>document.querySelector(s);
let empresaAtual=localStorage.getItem('empresa')||'MERCATTO DEL√çCIA';
let gerenteAtual=localStorage.getItem('gerente')||'Gerente';
$('#empresaTitulo').textContent=`Empresa: ${empresaAtual}`;
$('#usuarioInfo').textContent=`Gerente: ${gerenteAtual}`;
let manutencoes=[], calendar;

/* ================== CARREGAR DADOS ================== */
(async function init(){
  await carregar();
  initCalendar();
  setInterval(carregar,60000);
})();

async function carregar(){
  try{
    const res=await fetch(`${GAS_URL}?action=manutencoes&empresa=${encodeURIComponent(empresaAtual)}`);
    manutencoes=await res.json()||[];
    atualizarResumo();
    if(calendar) atualizarEventos();
  }catch{toast('‚ö†Ô∏è Erro ao carregar.');}
}

/* ================== CALEND√ÅRIO ================== */
function initCalendar(){
  const el=document.getElementById('calendar');
  calendar=new FullCalendar.Calendar(el,{
    initialView:'dayGridMonth',
    locale:'pt-br',
    height:'auto',
    headerToolbar:{left:'prev,next today',center:'title',right:''},
    events:[],
    eventClick:info=>{
      const e=info.event.extendedProps;
      abrirPopup(e.item,e.status,e.detalhes,e.responsavel,e.dataAgendada);
    }
  });
  calendar.render();
  atualizarEventos();
}

function atualizarEventos(){
  const eventos=manutencoes.map(m=>{
    let cor='fc-event-outro';
    if(m.status?.toLowerCase().includes('concl')) cor='fc-event-concluido';
    else if(m.status?.toLowerCase().includes('pend')) cor='fc-event-pendente';
    return {
      title:m.item,
      start:parseDataISO(m.dataAgendada||m.data||new Date()),
      className:[cor],
      extendedProps:m
    };
  });
  calendar.removeAllEvents();
  calendar.addEventSource(eventos);
}

function parseDataISO(d){
  try{
    if(!d)return new Date();
    if(d.includes('/')){const [dd,mm,aa]=d.split('/');return `${aa}-${mm}-${dd}`;}
    return d;
  }catch{return new Date();}
}

/* ================== POPUP A√á√ïES ================== */
function abrirPopup(item,status,detalhes,responsavel,dataAgendada){
  const p=document.createElement('div');
  p.className='popup-bg';
  p.innerHTML=`
  <div class="popup">
    <h3>${item}</h3>
    <p>${detalhes||''}</p>
    <p><b>Respons√°vel:</b> ${responsavel||'-'}<br><b>Data:</b> ${dataAgendada||'-'}</p>
    <textarea id="just" placeholder="Observa√ß√£o..."></textarea>
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:10px">
      <button onclick="registrar('${item}','Conclu√≠do')">‚úÖ Concluir</button>
      <button onclick="registrar('${item}','Reagendar')">üîÅ Reagendar</button>
      <button onclick="registrar('${item}','Cancelado')">‚ùå Cancelar</button>
    </div>
    <button style="margin-top:10px" onclick="this.closest('.popup-bg').remove()">Fechar</button>
  </div>`;
  document.body.appendChild(p);
}

async function registrar(item,acao){
  const obs=document.getElementById('just').value.trim();
  try{
    await fetch(GAS_URL,{method:'POST',body:JSON.stringify({
      action:'registrarManutencao',
      empresa:empresaAtual,gerente:gerenteAtual,item,acao,observacao:obs
    })});
    toast(`‚úÖ ${acao} registrado.`);
    document.querySelector('.popup-bg').remove();
    await carregar();
  }catch{toast('Erro ao registrar.');}
}

/* ================== RESUMO ================== */
function atualizarResumo(){
  const mesAtual=new Date().getMonth(), anoAtual=new Date().getFullYear();
  const filtro=manutencoes.filter(m=>{
    const d=parseDataObj(m.dataAgendada||m.data);
    return d.getMonth()===mesAtual && d.getFullYear()===anoAtual;
  });
  const pend=filtro.filter(m=>m.status?.toLowerCase().includes('pend')).length;
  const concl=filtro.filter(m=>m.status?.toLowerCase().includes('concl')).length;
  $('#pendentesMes').textContent=pend;
  $('#concluidasMes').textContent=concl;
}
function parseDataObj(d){try{if(!d)return new Date();if(d.includes('/')){const [dd,mm,aa]=d.split('/');return new Date(aa,mm-1,dd);}return new Date(d);}catch{return new Date();}}

/* ================== FINALIZAR DIA ================== */
async function finalizarDia(){
  try{
    await fetch(GAS_URL,{method:'POST',body:JSON.stringify({
      action:'finalizarManutencoes',
      empresa:empresaAtual,gerente:gerenteAtual
    })});
    toast('üéØ Dia finalizado.');
  }catch{toast('Erro ao finalizar.');}
}

/* ================== UTIL ================== */
function voltar(){window.location.href='index.html';}
function toast(msg){
  const el=$('#toast');
  el.textContent=msg;el.style.display='block';
  clearTimeout(el.timeout);el.timeout=setTimeout(()=>el.style.display='none',2000);
}
</script>
</body>
</html>
